<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="css/style.css" />
  <title>JWT Auth Demo</title>
</head>
<body>
  <h1>Server Token Decode</h1>
  <p id="serverMessage"> </p>
  <button id="changeUserButton">Change User</button>

  <script>
    const serverMessageEl = document.getElementById('serverMessage');
    const API_BASE_URL = 'http://localhost:3500';
    const changeUser = document.getElementById('changeUserButton');

    // Button click redirects to /edit
    changeUser.addEventListener('click', () => {
      window.location.href = '/edit';
    });

    // Main function to fetch protected data
    async function fetchProtectedData() {
      const token = localStorage.getItem('accessToken');

      let response = await fetch(`${API_BASE_URL}/getInfo`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      if (response.status === 403) {
        const newToken = await refreshToken();
        if (newToken) {
          response = await fetch(`${API_BASE_URL}/getInfo`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${newToken}`
            }
          });
        }
      }

      serverMessageEl.textContent = await response.text();
    }

    async function refreshToken() {
      const response = await fetch(`${API_BASE_URL}/refresh`, {
        method: 'GET',
        credentials: 'include'
      });
      
      const data = await response.json();
      localStorage.setItem('accessToken', data.accessToken);
      return data.accessToken;
    }

    fetchProtectedData().catch(() => {
      serverMessageEl.textContent = 'Failed to load data';
    });
  </script>
</body>
</html>
