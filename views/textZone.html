<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="stylesheet" href="css/style.css" />
  <title>TextZone</title>
</head>
<body>

  <h1>Your Files</h1>
  <button id="createFileBtn">Create New File</button>

  <ul id="fileList"> <li>Loading...</li> </ul> <!-- The file name as link and the creator -->

  <!-- --- Modal --- -->
  <div id="optionsModal" class="modal">
    <div class="modal-content">
      <h3>File Options</h3>
      <p id="modalFileName"></p>
      <button onclick="handleDownload()">Download</button>
      <button onclick="handleRename()">Rename</button>
      <button onclick="handleDelete()">Delete</button>
      <button onclick="handlePermissions()">Permissions</button>
      <button onclick="handleMakePublic()">Make Public</button>
      <button onclick="closeModal()">Cancel</button>
    </div>
  </div>



  <script src="js/authHelper.js"></script> <!-- Access to refreshing token and verification -->
  <script>
    const fileList = document.getElementById('fileList');

    /*
      --- Now this file uses the authHelper.js to be more readable and consistent
      ------ fetchWithAuth handles the authToken and updates that when needed
      ------ it also handles the messages from server like 401 or 403.
    */

    //--------------------------------------------------------------------
    // Refresh to show updated list
    window.addEventListener('pageshow', async (event) => {
      if (event.persisted || performance.getEntriesByType("navigation")[0].type === "back_forward") {
        window.location.reload();
      }
    });

    //--------------------------------------------------------------------
    // List the Files Client can Access
    async function fetchFiles() {
      try {
        const response = await fetchWithAuth(`${API_BASE_URL}/assets`, {
          method: 'GET'
        });

        const data = await response.json();
        fileList.innerHTML = '';

        // Make sure the responce is valid.
        if (!Array.isArray(data) || data.length === 0) {
          fileList.innerHTML = '<li>No files found.</li>';
          return;
        }

        const uniqueFiles = [...new Set(data)];

        uniqueFiles.forEach(fileName => {
          const li = document.createElement('li');

          // Link to the file
          const link = document.createElement('a');
          link.href = `/BasicText?file=${encodeURIComponent(fileName)}`;
          const fileParts = fileName.split('/');
          link.textContent = `${fileParts[1]} [${fileParts[0]}]`;
          li.appendChild(link);

          // Button for options
          const optionsBtn = document.createElement('button');
          optionsBtn.textContent = 'Options';
          optionsBtn.onclick = () => openModal(fileName);
          li.appendChild(optionsBtn);

          fileList.appendChild(li);
        });
      } catch (error) {
        fileList.innerHTML = '<li>Failed to load data</li>';
      }
    }
    fetchFiles();


    async function downloadFile(fileName) {
      try {
        const [creator, actualFileName] = fileName.split('/');
        const url = `${API_BASE_URL}/assets/download/${encodeURIComponent(creator)}/${encodeURIComponent(actualFileName)}`;

        const response = await fetchWithAuth(url, { method: 'GET' });

        if (!response.ok) {
          throw new Error(`Failed to download: ${response.statusText}`);
        }

        const contentDisposition = response.headers.get('content-disposition');
        const downloadName = contentDisposition
          ? contentDisposition.split('filename=')[1].replace(/"/g, '')
          : `${actualFileName}.json`;

        const blob = await response.blob();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = downloadName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      } catch (error) {
        console.error('Download error:', error);
        alert(`Download failed: ${error.message}`);
      }
    }

    
    //--------------------------------------------------------------
    // The deletion of a file. Maybe later make it remove from the user's list
    // --- if they were not the one to create it.
    async function deleteFile(fileName) {
      try {
        const response = await fetchWithAuth(`${API_BASE_URL}/assets`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ fileName })
        });

        if (!response.ok) {
          throw new Error(`Delete failed: ${response.statusText}`);
        }

        return true;
      } catch (error) {
        console.error('Delete error:', error);
        alert('Failed to delete file. Please try again.');
        return false;
      }
    }


    //--------------------------------------------------------------
    // Modal functionality
    let currentFileName = '';

    function openModal(fileName) {
      currentFileName = fileName;
      document.getElementById('modalFileName').textContent = fileName;
      document.getElementById('optionsModal').style.display = 'flex';
    }

    function closeModal() {
      currentFileName = '';
      document.getElementById('optionsModal').style.display = 'none';
    }

    async function handleDownload() {
      await downloadFile(currentFileName);
    }

    async function handleDelete() {
      if (confirm(`Delete "${currentFileName}"?`)) {
        await deleteFile(currentFileName);
        closeModal();
        fetchFiles();
      }
    }

    function handleRename() {
      alert('Rename feature coming soon...');
    }

    function handlePermissions() {
      alert('Permissions feature coming soon...');
    }

    function handleMakePublic() {
      alert('Make Public feature coming soon...');
    }


    //--------------------------------------------------------------
    // The button for BasicText. Simple, do not forget
    document.getElementById('createFileBtn').onclick = function () {
      window.location.href = '/BasicText';
    };
  </script>

</body>
</html>
